{% extends 'base.html' %}
{% load vote_tags %}

{% block title %}Problem - CodeClinic{% endblock %}

{% block content %}

<div class="detail-container">

    <div class="card problem-detail-card">
        <h2 class="problem-heading">{{ problem.description|truncatechars:70 }}</h2>
        <p class="full-description">{{ problem.description }}</p>
        <div class="meta">
            <span>Submitted by <strong>{{ problem.user.username }}</strong></span>
            <span>‚Ä¢</span>
            <span>{{ problem.created_at|date:"M d, Y" }}</span>
        </div>
    </div>

    <h3 class="section-title">Solutions</h3>

    {% if user.is_authenticated %}
        <div class="card submit-human-solution">
            <h4 class="section-subtitle">Add Your Answer</h4>
            <form method="POST" action="{% url 'add_human_solution' problem.id %}">
                {% csrf_token %}
                <textarea 
                    name="content" 
                    placeholder="Write your solution here..." 
                    required 
                    class="form-textarea large-textarea"
                    rows="10"></textarea>
                <button type="submit" class="btn btn-submit">Submit Answer</button>
            </form>
        </div>
    {% else %}
        <p class="login-prompt"><a href="{% url 'login' %}">Log in</a> to add your own answer.</p>
    {% endif %}

    {% for solution in solutions %}
        <div class="card solution-card {% if solution.ai_generated %}ai-solution{% else %}human-solution{% endif %}">

            <div class="solution-header">
                <div class="badges">
                    <span class="badge {% if solution.ai_generated %}ai-badge{% else %}human-badge{% endif %}">
                        {% if solution.ai_generated %}AI Generated{% else %}Community Answer{% endif %}
                    </span>

                    {% if solution.answer_type %}
                        <span class="badge intent-badge intent-{{ solution.answer_type }}">
                            {{ solution.get_answer_type_display }}
                        </span>
                    {% endif %}
                </div>

                {% if not solution.ai_generated %}
                    <span class="solution-meta">by {{ solution.author.username }}</span>
                {% endif %}
            </div>

            <div class="solution-body {% if solution.answer_type %}solution-{{ solution.answer_type }}{% endif %}">
                <pre class="code-block">{{ solution.content }}</pre>
            </div>

            <div class="solution-votes">
                <button class="vote-btn upvote" onclick="voteSolution({{ solution.id }}, 'up')">üëç</button>
                <span id="upvotes-{{ solution.id }}">{{ solution.upvotes_count }}</span>

                <button class="vote-btn downvote" onclick="voteSolution({{ solution.id }}, 'down')">üëé</button>
                <span id="downvotes-{{ solution.id }}">{{ solution.downvotes_count }}</span>
            </div>

            <h4 class="comment-title">Comments</h4>
            <div class="comment-section">
                {% for comment in solution.comments.all %}
                    <div class="comment">
                        <strong>{{ comment.author.username }}</strong>: {{ comment.content }}
                        <small class="comment-date">{{ comment.created_at|date:"M d, Y H:i" }}</small>
                    </div>
                {% empty %}
                    <p class="no-comments">No comments yet.</p>
                {% endfor %}
            </div>

            <form method="POST" action="{% url 'add_comment' solution.id %}" class="comment-form">
                {% csrf_token %}
                <input type="text" name="content" placeholder="Add a comment..." required class="form-input">
                <button type="submit" class="btn btn-comment">Comment</button>
            </form>

        </div>
    {% empty %}
        <p class="no-items">No solutions yet.</p>
    {% endfor %}

</div>

<script>
function voteSolution(solutionId, type) {
    fetch(`/vote/${solutionId}/${type}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById(`upvotes-${solutionId}`).innerText = data.upvotes;
        document.getElementById(`downvotes-${solutionId}`).innerText = data.downvotes;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}
